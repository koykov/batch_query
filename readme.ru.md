# Batch Query

Эта библиотека помогает объеденить множество мелких однотипных запросов к различным ресурсам (базам данных, кэшам, сетям)
в батчи и тем самым снизить накладные расходы на соединенях и транспорте данных.

Библиотека изначально повилась в ответ на постоянные проблемы между высоконагруженным сервисом и сервером Aerospike.
Метрики самого Aerospike упорно показывали, что он недозагружен, в то время как метрики приложения указывали на огромные
тайминги запросов к Aerospike. Также создание библиотеки было вдохновлено пакетом
[singleflight](https://pkg.go.dev/golang.org/x/sync/singleflight) - сама идея уменьшить количество мелких запросов,
в виде логичного продолжения, пришла к мысли избавиться от них вообще.

Сама идея решения очень простая: собирать мелкие запросы до тех пор, пока не будет достигнут предел по количеству
(максимальный размер батча) или пока не истечёт время сбора батча (с момента поступления первого мелкого запроса в батч).

## Использование

Центральным компонентом библиотеки является структура `BatchQuery`, которая и выполняет всю работу. Перед использованием 
её необходимо настроить и для этих целей служит структура [`Config`](config.go). Давайте рассмотрим её поля:
* `BatchSize` - сколько мелких запросов может иметь батч. Поле необязательно, значение по умолчанию `64`.
* `CollectInterval` - максимальная продолжительность сбора батча. Начинает отсчитываться с момента поступления первого запроса в батч. Значение по умолчанию `1` секунда..
* `TimeoutInterval` - ограничение на сбор, отправку батч-запроса и пост-обработку. Должно быть больше `CollectInterval`.
* `Batcher` - абстракция для конкретного хранилища, см. описание ниже. Обязательный параметр.
* `Buffer` - хранилище для собранных батчей, готовых к отправке и обработке.
* `Workers` - количество воркеров для отправки/обработки батчей. Читают из буфера (см. `Buffer`).
* `MetricsWriter` - абстракция для конкретного TSDB решения.
* `Logger` - абстракция для логгера внутренних процессов. Полезно для отладки, не рекомендуется для продакшена.
